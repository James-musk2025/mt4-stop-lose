# MT4 止损止盈设置脚本使用说明

## 📋 脚本概述

**文件名：** `StopLossTakeProfitSetter.mq4`  
**版本：** 1.00  
**作者：** Kilo Code  
**类型：** MT4 脚本 (Script)

这是一个功能强大的MT4脚本，用于批量设置订单的止损和止盈。脚本基于点数计算，支持买单和卖单，提供完整的价格验证和错误处理机制。

## 🎯 主要功能

- ✅ **基于点数设置**：输入相对于开仓价的点数来设置止损止盈
- ✅ **批量处理**：一次性处理多个符合条件的订单
- ✅ **智能过滤**：支持按货币对、魔术数字、注释过滤订单
- ✅ **安全验证**：完整的价格验证和市场限制检查
- ✅ **执行确认**：执行前显示详细预览，用户确认后执行
- ✅ **错误处理**：自动重试机制和详细的错误报告
- ✅ **精确计算**：考虑Tick Size和价格精度的标准化

## 📥 安装方法

1. 将 `StopLossTakeProfitSetter.mq4` 文件复制到MT4的 `Scripts` 文件夹
2. 重启MT4或按F4刷新导航器
3. 在导航器的"脚本"部分找到该脚本

## ⚙️ 参数设置

### 止损止盈设置
- **止损点数 (StopLossPoints)**：设置止损的点数
  - 正数：设置新的止损点数
  - 0：保持原有止损不变
  - -1：清空止损
- **止盈点数 (TakeProfitPoints)**：设置止盈的点数
  - 正数：设置新的止盈点数
  - 0：保持原有止盈不变
  - -1：清空止盈

### 订单过滤选项
- **仅应用于当前货币对 (OnlyCurrentSymbol)**：true=只处理当前图表的货币对
- **仅应用于买单 (OnlyBuyOrders)**：true=只处理买单（OP_BUY）
- **仅应用于卖单 (OnlySellOrders)**：true=只处理卖单（OP_SELL）
- **使用魔术数字过滤 (UseMagicFilter)**：true=启用魔术数字过滤
- **魔术数字 (MagicNumber)**：指定要处理的魔术数字
- **使用注释过滤 (UseCommentFilter)**：true=启用注释过滤
- **注释过滤文本 (CommentFilter)**：包含此文本的订单才会被处理

### 执行选项
- **执行前确认 (ConfirmBeforeExecution)**：true=执行前显示确认对话框
- **最大重试次数 (MaxRetries)**：订单修改失败时的重试次数（1-10）
- **显示详细日志 (ShowDetailedLog)**：true=显示详细的执行日志

## 🚀 使用步骤

### 1. 正确启动脚本以显示参数设置

**方法1：右键菜单（推荐）**
1. 在MT4导航器中找到脚本
2. **右键点击**脚本名称
3. 选择"**附加到图表**"
4. 参数设置窗口会弹出

**方法2：拖拽方式**
1. 从导航器中**拖拽**脚本到图表上
2. 在拖拽过程中**按住Ctrl键**
3. 释放时会显示参数设置窗口

**方法3：如果双击没有参数窗口**
- 重新编译脚本（按F7）
- 确保脚本文件包含 `#property show_inputs`
- 尝试重启MT4

### 2. 参数设置
在弹出的参数设置窗口中，您可以修改：
- 设置止损点数（例如：500）
- 设置止盈点数（例如：1000）
- 选择是否仅处理当前货币对
- 配置其他过滤和执行选项

### 3. 执行脚本
1. 点击"确定"运行脚本
2. 查看预览信息，确认无误后点击"是"执行

### 📋 参数输入界面示例
```
┌─────────────────────────────────────┐
│           参数设置                   │
├─────────────────────────────────────┤
│ 止损点数: [500    ]                 │
│ 止盈点数: [1000   ]                 │
│ 仅应用于当前货币对: [✓]             │
│ 使用魔术数字过滤: [ ]               │
│ 魔术数字: [0      ]                 │
│ 使用注释过滤: [ ]                   │
│ 注释过滤文本: [           ]         │
│ 执行前确认: [✓]                     │
│ 最大重试次数: [3  ]                 │
│ 显示详细日志: [✓]                   │
├─────────────────────────────────────┤
│      [确定]      [取消]             │
└─────────────────────────────────────┘
```

### 2. 高级过滤使用
如果您想只处理特定的订单：

**按魔术数字过滤：**
- 勾选"使用魔术数字过滤"
- 输入目标魔术数字（例如：12345）

**按注释过滤：**
- 勾选"使用注释过滤"
- 输入注释关键词（例如："EA1"）

**按订单类型过滤：**
- 勾选"仅应用于买单"：只处理买单
- 勾选"仅应用于卖单"：只处理卖单
- 两者都不勾选：处理所有订单类型

## 📊 计算逻辑

### 买单 (OP_BUY)
- **止损价格** = 开仓价 - (止损点数 × Point)
- **止盈价格** = 开仓价 + (止盈点数 × Point)

### 卖单 (OP_SELL)
- **止损价格** = 开仓价 + (止损点数 × Point)
- **止盈价格** = 开仓价 - (止盈点数 × Point)

### 示例计算
假设EURUSD买单，开仓价1.0500，设置止损500点，止盈1000点：
- 止损价格 = 1.0500 - (500 × 0.00001) = 1.0450
- 止盈价格 = 1.0500 + (1000 × 0.00001) = 1.0600

### 高级功能

#### 1. 保持原有功能
- **止损设置为0**：保持订单原有的止损价格不变
- **止盈设置为0**：保持订单原有的止盈价格不变

#### 2. 清空功能
- **止损设置为-1**：清空订单的止损（设置为0）
- **止盈设置为-1**：清空订单的止盈（设置为0）

#### 3. 订单类型过滤
- **仅买单**：只处理买单（多头持仓）
- **仅卖单**：只处理卖单（空头持仓）
- **注意**：不能同时选择仅买单和仅卖单

**使用示例：**
- 止损点数：500，止盈点数：0 → 设置新止损，保持原有止盈
- 止损点数：0，止盈点数：1000 → 保持原有止损，设置新止盈
- 止损点数：-1，止盈点数：0 → 清空止损，保持原有止盈
- 止损点数：500，止盈点数：-1 → 设置新止损，清空止盈

## 🛡️ 安全机制

### 价格验证
- **最小距离检查**：确保止损止盈距离当前价格满足经纪商要求
- **Tick Size调整**：自动调整价格到有效的价格刻度
- **精度标准化**：根据货币对小数位数格式化价格

### 错误处理
- **自动重试**：网络繁忙时自动重试
- **详细日志**：记录每个操作的详细信息
- **失败统计**：提供完整的执行报告

## 📝 执行报告示例

```
=== 止损止盈设置脚本预览 ===
货币对: EURUSD
订单类型: 仅买单
止损点数: -1 点 (清空)
止盈点数: 1000 点

订单 #12345: 买单, 开仓价: 1.05000
  止损: 清空
  新止盈: 1.06000 (1000点)

总共将处理 1 个订单。

=== 执行报告 ===
总订单数: 5
符合条件订单数: 1
成功修改: 1
修改失败: 0
跳过订单: 0
成功率: 100.0%
```

## ⚠️ 注意事项

### 使用前检查
1. **确保交易权限**：MT4必须允许自动交易
2. **检查网络连接**：确保与服务器连接稳定
3. **验证参数设置**：确认点数设置合理
4. **测试环境**：建议先在模拟账户测试

### 风险提示
1. **市场风险**：止损止盈设置不当可能影响交易结果
2. **技术风险**：网络中断可能导致部分订单未处理
3. **操作风险**：错误的参数设置可能导致意外结果

### 最佳实践
1. **小批量测试**：首次使用时先处理少量订单
2. **参数验证**：执行前仔细检查预览信息
3. **日志监控**：关注执行日志，及时发现问题
4. **定期备份**：重要操作前备份账户状态

## 🔧 故障排除

### 常见错误及解决方案

**错误：无效的交易参数**
- 检查止损止盈点数是否合理
- 确认价格是否满足最小距离要求

**错误：服务器忙**
- 脚本会自动重试，请耐心等待
- 如持续失败，请稍后再试

**错误：权限不足**
- 检查MT4是否允许自动交易
- 确认账户是否有修改订单的权限

**错误：价格改变**
- 市场波动导致，脚本会自动重试
- 可以重新运行脚本

### 日志分析
脚本会在MT4的"专家"标签页显示详细日志：
- `成功:` 表示订单修改成功
- `失败:` 表示订单修改失败
- `警告:` 表示价格验证问题
- `跳过:` 表示订单被跳过

## 📞 技术支持

如果您在使用过程中遇到问题：
1. 查看MT4专家标签页的详细日志
2. 检查参数设置是否正确
3. 确认网络连接和交易权限
4. 参考本文档的故障排除部分

## 📄 版本历史

**v1.00 (2025-01-03)**
- 初始版本发布
- 支持基于点数的止损止盈设置
- 完整的价格验证和错误处理
- 用户友好的确认界面

---

**免责声明：** 本脚本仅供学习和参考使用。使用者应当充分了解外汇交易的风险，并对使用本脚本产生的任何后果承担全部责任。作者不对使用本脚本造成的任何损失承担责任。